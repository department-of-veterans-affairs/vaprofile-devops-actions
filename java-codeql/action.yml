name: "Auto CodeQL Analysis"
description: "Security Code Scanning with Auto Mode CodeQL"
inputs:
  language:
    description: "Language to analyze (java, actions)"
    required: true
  maven-settings-xml:
    description: "Maven settings.xml content"
    required: false

runs:
  using: "composite"
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Corretto JDK
      if: inputs.language == 'java'
      uses: actions/setup-java@v4
      with:
        distribution: corretto
        java-version: "21"

    - name: Set up Maven
      if: inputs.language == 'java'
      uses: stCarolas/setup-maven@v4
      with:
        maven-version: "3.9.9"

    - name: Cache Maven repository
      if: inputs.language == 'java'
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: >
          ${{ runner.os }}-jdk21-corretto-maven3.9.9-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-jdk21-corretto-maven3.9.9-

    - name: Configure Maven settings.xml
      if: inputs.language == 'java'
      shell: bash
      run: |
        mkdir -p ~/.m2
        echo "${{ inputs.maven-settings-xml }}" > ~/.m2/settings.xml
        echo "MAVEN_CONFIG=--settings $HOME/.m2/settings.xml" >> $GITHUB_ENV

    - name: Verify Java & Maven
      if: inputs.language == 'java'
      shell: bash
      run: |
        java -version
        mvn -v

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: ${{ inputs.language }}

    - name: Autobuild
      if: inputs.language == 'java'
      uses: github/codeql-action/autobuild@v4

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4
      with:
        category: "ois-${{ inputs.language }}"

    - name: Generate CodeQL Results CSV
      shell: bash
      run: |
        set -euo pipefail

        CODEQL_BIN="$(ls $RUNNER_TOOL_CACHE/CodeQL/*/x64/codeql/codeql | head -n 1)"
        DB_BASE="${RUNNER_TEMP}/codeql_databases"
        db_dir="$DB_BASE/${{ inputs.language }}"
        output="${RUNNER_TEMP}/codeql-scan-results-${{ inputs.language }}.csv"

        if [[ ! -d "$db_dir" ]]; then
          echo "CodeQL database not found for ${{ inputs.language }}"
          exit 1
        fi

        "$CODEQL_BIN" database interpret-results \
          "$db_dir" \
          --format=csv \
          --output="$output"

    - name: Upload CodeQL CSV Artifact
      uses: actions/upload-artifact@v4
      with:
        name: codeql-scan-results-${{ inputs.language }}
        path: ${{ runner.temp }}/codeql-scan-results-${{ inputs.language }}.csv
